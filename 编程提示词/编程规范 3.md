# AI代码生成规范 - 最终版

---

## 1. 命名（不可违反）

python

```python
# 文件名
user_service.py          # 小写+下划线

# 函数名：动词开头
def calculate_price():
def fetch_user():
def validate_email():

# 变量名：名词
user_list: list[dict] = []
total_price: float = 0.0
is_valid: bool = False

# 类名：大驼峰
class UserService:
class OrderProcessor:

# 常量：全大写
MAX_RETRY = 3
API_KEY = ""
```

**禁止：缩写、单字母（除i/j/k）、拼音**

---

## 2. 类型标注（必须）

python

```python
# 所有函数必须有类型标注
def process(
    user_id: int,
    data: dict[str, Any],
    config: dict[str, Any] | None = None
) -> dict[str, Any]:
    pass

# 基础类型
name: str
age: int
price: Decimal          # 金额用Decimal，不用float
is_active: bool

# 容器
items: list[str]
mapping: dict[int, str]
unique: set[int]
point: tuple[float, float]

# 可选
email: str | None = None
```

---

## 3. 函数结构（强制）

### 3.1 最多3层嵌套

python

```python
# ✅ 正确
def process(order: dict) -> bool:
    if not order:
        return False
    if order["status"] != "pending":
        return False
    # 主逻辑
    return True

# ❌ 错误：超过3层
def process(order: dict) -> bool:
    if order:
        if order["status"] == "pending":
            if order["amount"] > 0:
                if order["user_id"] > 0:  # 第4层
```

### 3.2 参数校验在开头

python

```python
def transfer(from_id: int, to_id: int, amount: Decimal) -> bool:
    # 第一步：校验
    if from_id <= 0:
        raise ValueError(f"Invalid from_id: {from_id}")
    if to_id <= 0:
        raise ValueError(f"Invalid to_id: {to_id}")
    if amount <= 0:
        raise ValueError(f"Amount must be positive: {amount}")
    
    # 第二步:业务逻辑
    ...
```

### 3.3 最多5个参数

超过5个用dataclass或dict封装

---

## 4. 数据结构（必须遵守）

python

```python
from dataclasses import dataclass, field
from decimal import Decimal
from enum import Enum

# 状态用Enum
class Status(Enum):
    PENDING = "pending"
    ACTIVE = "active"

# 固定字段用dataclass
@dataclass
class User:
    id: int
    name: str
    email: str
    orders: list[dict] = field(default_factory=list)  # 可变默认值用factory

# 金额用Decimal
price: Decimal = Decimal("99.99")

# 容器选择
cache: dict[int, User] = {}      # 查找
unique_ids: set[int] = set()     # 去重
items: list[str] = []            # 顺序
config: tuple[str, int] = (...)  # 不可变
```

---

## 5. 错误处理（强制）

python

```python
# 使用具体异常
raise ValueError(f"Invalid user_id: {user_id}, expected positive int")
raise TypeError(f"Expected str, got {type(value)}")
raise FileNotFoundError(f"File not found: {path}")

# ❌ 禁止
raise Exception("Error")
```

---

## 6. Docstring（必须）

python

```python
def calculate(price: Decimal, rate: float) -> Decimal:
    """
    计算折扣后价格
    
    Args:
        price: 原价，必须>0
        rate: 折扣率，范围0-1
    
    Returns:
        折扣后的价格
    
    Raises:
        ValueError: 参数无效时
    """
    if price <= 0:
        raise ValueError(f"Invalid price: {price}")
    if not 0 <= rate <= 1:
        raise ValueError(f"Invalid rate: {rate}")
    return price * Decimal(str(1 - rate))
```

---

## 7. 导入顺序

python

```python
# 标准库
import os
from datetime import datetime

# 第三方库
import requests

# 本地模块
from .models import User
```

---

## 8. 配置管理

python

```python
import os

# 从环境变量读取
DATABASE_URL = os.getenv("DATABASE_URL")
if not DATABASE_URL:
    raise ValueError("DATABASE_URL is required")

# ❌ 禁止硬编码
DATABASE_URL = "mysql://localhost/db"
```

---

## 9. 性能禁止模式

python

```python
# ❌ N+1查询
for user in users:
    orders = db.query(f"WHERE user_id={user.id}")

# ✅ 批量查询
user_ids = [u.id for u in users]
orders = db.query(f"WHERE user_id IN ({user_ids})")

# ❌ 循环中重复计算
for item in items:
    result = expensive_func()

# ✅ 提取到外部
result = expensive_func()
for item in items:
    use(result)

# ❌ 用list查找
items = []
if x in items:  # O(n)

# ✅ 用set
items = set()
if x in items:  # O(1)
```